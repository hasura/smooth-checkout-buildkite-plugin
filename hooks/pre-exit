#!/usr/bin/env bash

set -eo pipefail

if [[ "$BUILDKITE_PLUGIN_SMOOTH_CHECKOUT_SKIP_CHECKOUT" == "true" \
    || "$BUILDKITE_PLUGIN_SMOOTH_CHECKOUT_DELETE_CHECKOUT" != "true" ]]; then
  exit 0
fi

echo "Removing checkout directory: $BUILDKITE_BUILD_CHECKOUT_PATH"

rm -rf "$BUILDKITE_BUILD_CHECKOUT_PATH" || true

if [ -d "$BUILDKITE_BUILD_CHECKOUT_PATH" ]; then
  echo "Tried running: rm -rf $BUILDKITE_BUILD_CHECKOUT_PATH"
  echo "But it failed leaving the following files as residue"
  ls -la $BUILDKITE_BUILD_CHECKOUT_PATH
fi

if [ -d "$BUILDKITE_BUILD_CHECKOUT_PATH" ]; then
  echo "Trying to cleanup $BUILDKITE_BUILD_CHECKOUT_PATH using sudo"
  sudo -n rm -rf "$BUILDKITE_BUILD_CHECKOUT_PATH"
fi

if [ -d "$BUILDKITE_BUILD_CHECKOUT_PATH" ]; then
  echo "Cleanup was not successful."
else
  echo "Cleanup completed successfully."
fi